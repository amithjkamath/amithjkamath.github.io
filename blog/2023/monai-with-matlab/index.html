<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> PyTorch with MATLAB: calling a UNet trained with PyTorch/MONAI in MATLAB | Amith J. Kamath </title> <meta name="author" content="Amith J. Kamath"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://amithjkamath.github.io/blog/2023/monai-with-matlab/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Amith</span> J. Kamath </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Notes </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">more </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/publications/">Publications</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/teaching/">Teaching</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/glossary/">Glossary</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">PyTorch with MATLAB: calling a UNet trained with PyTorch/MONAI in MATLAB </h1> <p class="post-meta"> Created on May 20, 2023 </p> <p class="post-tags"> <a href="/blog/2023"> <i class="fa-solid fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/category/matlab"> <i class="fa-solid fa-tag fa-sm"></i> matlab,</a>   <a href="/blog/category/programming"> <i class="fa-solid fa-tag fa-sm"></i> programming,</a>   <a href="/blog/category/computer-vision"> <i class="fa-solid fa-tag fa-sm"></i> computer-vision</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>In this short post, we will attempt to run a UNet model implemented using PyTorch (and MONAI, really) within MATLAB. All the associated code and data is available at https://github.com/amithjkamath/monai-from-matlab</p> <p>This is inspired by questions on MATLAB Answers like this:</p> <p><img src="../assets/img/how-to-load-pytorch-matlab.png" alt="How to load PyTorch model into MATLAB"></p> <p>or</p> <p><img src="../assets/img/loading-pth-model-matlab.png" alt="How to load .pth file into MATLAB"></p> <p>Now one may ask what the use-case for this is, for which I have the following three points:</p> <ul> <li>You already have some pre-processing/post-processing code in MATLAB that you don’t want to re-implement with python.</li> <li>You are primarily a MATLAB user, and have been handed off a fancy deep learning model from a colleague who doesn’t care enough to help you use it somehow.</li> <li>You need to do some interactive labeling (something this post doesn’t delve into) and don’t want to re-invent the wheel and instead want to use the Labeler Apps in MATLAB.</li> </ul> <p>If you fall into these three (or potentially another unknown) categories, read on.</p> <hr> <h2 id="setting-up-the-matlab--python-interface">Setting up the MATLAB + Python interface</h2> <p>This is a pre-requisite for the rest of the steps, and even though could be rather involved, it is a one-time setup, and hence not so difficult. Here’s how I did this on my MacOS 13.3 running MATLAB R2022b:</p> <h3 id="1-create-a-new-matlab-conda-environment">1. Create a new MATLAB conda environment</h3> <p>Assuming you have Anaconda/miniconda setup (see https://docs.anaconda.com/free/anaconda/install/index.html if you haven’t already), I recommend creating a separate environment to interact with MATLAB. This can be done in the terminal using:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% conda create --name matlab-env python=3.9
</code></pre></div></div> <p>Make sure the version of python matches one that is supported by your MATLAB version here: https://ch.mathworks.com/support/requirements/python-compatibility.html (in my case, 3.9 worked).</p> <p>Then, activate the environment and find out where the python executable is:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% conda activate matlab-env 
</code></pre></div></div> <p>Then, you run:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% which python
</code></pre></div></div> <p>to find the location of the python executable. In my case, for example, it is here (remember this for step 3):</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/amithkamath/opt/anaconda3/envs/matlab-env/bin/python
</code></pre></div></div> <h3 id="2-install-python-dependencies">2. Install python dependencies</h3> <p>Next, install pytorch/monai (or whatever dependencies your python code while running in MATLAB has) using %conda install … . To run examples from PyTorch for segmentation, we need both PyTorch and torchvision installed.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>% conda install pytorch torchvision
</code></pre></div></div> <p>If required, also consider installing monai using</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>%pip install monai
</code></pre></div></div> <p>(If pip isn’t available, you need to set it up, using %conda install pip)</p> <h3 id="3-get-matlab-to-recognize-this-environment--libraries">3. Get MATLAB to recognize this environment + libraries</h3> <p>Now start MATLAB and run pyversion with this path (from step 1 above). In my case, this turns out to be:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt; pyversion('/Users/amithkamath/opt/anaconda3/envs/matlab-env/bin/python')
</code></pre></div></div> <p>And check that <code class="language-plaintext highlighter-rouge">pe = pyenv</code> points to the right locations and all the fields make sense. This returns:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pe = 
    PythonEnvironment with properties:

    Version: "3.9"
    Executable: "/Users/amithkamath/opt/anaconda3/envs/matlab-env/bin/python"
    Library: "/Users/amithkamath/opt/anaconda3/envs/matlab-env/lib/libpython3.9.dylib"
    Home: "/Users/amithkamath/opt/anaconda3/envs/matlab-env"
    Status: Loaded
    ExecutionMode: OutOfProcess
    ProcessID: "67023"
    ProcessName: "MATLABPyHost"
</code></pre></div></div> <p>Finally, we need to load the python module with functions that are called from MATLAB. To do this, you need to add the module to the ‘path’, this is done using <code class="language-plaintext highlighter-rouge">py.importlib.import_module(‘’)</code>. For example, with the code in this demonstration, it should look something like this:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt;&gt; py.importlib.import_module('monaiInference')
    ans =

    Python module with properties:
        createModel: [1×1 py.function]
        &lt;module ... &gt;
</code></pre></div></div> <p>If all of this is setup, congratulations! You can now simply open the live-script titled <code class="language-plaintext highlighter-rouge">testMONAIConnector.mlx</code>, and follow along with the sections.</p> <hr> <h2 id="running-the-unet-model-inference">Running the UNet model inference:</h2> <p>In the first section, we reset the python environment within MATLAB, and load the module with the code we expect to run from. Note that while running MATLAB, you don’t need to activate the virtual environment separately, or even open the terminal at all. Once the previous setup has been tested (in step 3), everything else thereon is in MATLAB!</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>terminate(pyenv)
pyversion('/Users/amithkamath/opt/anaconda3/envs/matlab-env/bin/python')
py.importlib.import_module('monaiInference');
</code></pre></div></div> <p><a href="https://www.youtube.com/watch?v=imbnwMwNN7s" rel="external nofollow noopener" target="_blank"><img src="https://img.youtube.com/vi/imbnwMwNN7s/0.jpg" alt="Setting up Python within MATLAB"></a></p> <hr> <p>Next, we call directly the <code class="language-plaintext highlighter-rouge">create_model</code> function/method defined in the python module called <code class="language-plaintext highlighter-rouge">monaiInference</code> from MATLAB. The input to this function is the path to the <code class="language-plaintext highlighter-rouge">.pth</code> file where the weights have been saved. This creates a UNet object in the MATLAB workspace!</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>monaiUNet = py.monaiInference.create_model("heart-2d-model.pth")
</code></pre></div></div> <p>Note that you need to edit the <code class="language-plaintext highlighter-rouge">create_model</code> function to construct another architecture of your choice if the <code class="language-plaintext highlighter-rouge">.pth</code> file contains weights corresponding to that architecture. In this example, we use a UNet built using MONAI, and hence the code is really simple:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def create_model(model_path):
    config = {
        "unet_model_params": dict(
            spatial_dims=2,
            in_channels=1,
            out_channels=1,
            channels=(16, 32, 64, 128, 256, 512),
            strides=(2, 2, 2, 2, 2),
            num_res_units=0,
            norm=Norm.BATCH,
            act="ReLU",
            bias=False,
        ),
    }
    model = UNet(**config["unet_model_params"])
    model.load_state_dict(torch.load(model_path))
    return model
</code></pre></div></div> <p>Bear in mind to import all the necessary dependencies!</p> <p><a href="https://www.youtube.com/watch?v=_67CaMjQP6o" rel="external nofollow noopener" target="_blank"><img src="https://img.youtube.com/vi/_67CaMjQP6o/0.jpg" alt="Loading the UNet model in MATLAB"></a></p> <hr> <p>Then, we need to load images to run inference on, and this should be reasonably straightforward MATLAB code <code class="language-plaintext highlighter-rouge">imread</code> and so on. Note that we divide the image by 255 to scale the intensity. The model trained in MONAI used the <code class="language-plaintext highlighter-rouge">ScaleIntensity</code> transformation, and this operation simply mimics this pre-processing step. Also, if you’re confused with the <code class="language-plaintext highlighter-rouge">reshape</code> operation, this is needed because the model expects a 4-D array, where the first two are batch size and channel size - both of which are 1 for a single grayscale image.</p> <p><a href="https://www.youtube.com/watch?v=vPHbM5YNkMs" rel="external nofollow noopener" target="_blank"><img src="https://img.youtube.com/vi/vPHbM5YNkMs/0.jpg" alt="Reading example images into MATLAB"></a></p> <hr> <p>Finally, we run the inference. There’s some magic in this section that needs some explanation. The line to run inference is:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>seg = py.monaiInference.inference(monaiUNet, py.torch.tensor(py.numpy.array(im_channel)));
</code></pre></div></div> <p>Note that we need to cast the MATLAB array in <code class="language-plaintext highlighter-rouge">im_channel</code> first to a numpy array, and then to a torch tensor. The calls wrapping <code class="language-plaintext highlighter-rouge">py.numpy.array</code> and <code class="language-plaintext highlighter-rouge">py.torch.tensor</code> do just this, where <code class="language-plaintext highlighter-rouge">py</code> really indicates to MATLAB that whatever comes after it is from a module that’s available in the <code class="language-plaintext highlighter-rouge">pyenv</code> loaded. A similar story in this line:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>seg = squeeze(single(py.numpy.array(seg)));
</code></pre></div></div> <p>to undo these data type changes and bring things back to the MATLAB world. Of course these could be done more neatly within a function, but then it’s harder to show exactly what happens under the hood (and so pardon my shabby code in the interest of interpretability ;-) )</p> <p><a href="https://www.youtube.com/watch?v=hUo7Vr3tGW8" rel="external nofollow noopener" target="_blank"><img src="https://img.youtube.com/vi/hUo7Vr3tGW8/0.jpg" alt="Running inference on the UNet"></a></p> <hr> <p>And voila, there you have it: a fully functioning UNet model running within MATLAB! If you asked me a few years ago if something like this could be possible, I’d have laughed out loud. I’m glad to see how languages and tools evolve over time, and hope to see more movements in these directions!</p> <hr> <h2 id="references">References</h2> <p>https://github.com/matlab-deep-learning/Automate-Labeling-in-Image-Labeler-using-a-Pretrained-TensorFlow-Object-Detector for taking this a step further and running a model within an automation algorithm (possibly fodder for another blog post here, next!)</p> <p>https://ch.mathworks.com/products/matlab/matlab-and-python.html?requestedDomain=en for general notes on Python + MATLAB.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://www.caim.unibe.ch/about_us/people/interviews/amith_kamath/index_eng.html" target="_blank" rel="external nofollow noopener">About Us: "I would like to convert my research into a useful tool for clinicians." - Center for Artificial Intelligence in Medicine (CAIM)</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/plotly/">a post with plotly.js</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/photo-gallery/">a post with image galleries</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/tabs/">a post with tabs</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/typograms/">a post with typograms</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Amith J. Kamath. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. Last updated: April 24, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>